// 2011月12月31日以前に売れた商品を顧客別に集計
SELECT ST.CUSTOMER_ID, SD.PRODUCT_ID, COUNT(*) FROM SALES_TRAN ST JOIN SALES_DETAIL SD ON ST.SALES_ID = SD.SALES_ID
WHERE '2011-01-01' <= ST.SALES_DATE AND ST.SALES_DATE <= '2011-12-31'
GROUP BY ST.CUSTOMER_ID, SD.PRODUCT_ID;

// 2015年1月の売り上げが大きい顧客（大きい方ら順にソートして表示）
SELECT ST.CUSTOMER_ID, SUM(SD.PRODUCT_PRICE * SD.SALES_COUNT) SALES_AMOUNT
FROM SALES_TRAN ST
INNER JOIN SALES_DETAIL SD ON ST.SALES_ID = SD.SALES_ID
WHERE YEAR(ST.SALES_DATE) = '2015' AND MONTH(ST.SALES_DATE) = '01'
GROUP BY ST.CUSTOMER_ID
ORDER BY SALES_AMOUNT DESC;

// 2015年1月の前年同月と比べて売り上げが伸びた顧客 -- ビューを使う
CREATE VIEW THIS_SALES
AS SELECT ST.CUSTOMER_ID, SUM(SD.PRODUCT_PRICE * SD.SALES_COUNT) AS SALES_AMOUNT
FROM SALES_TRAN ST INNER JOIN SALES_DETAIL SD
ON ST.SALES_ID = SD.SALES_ID
WHERE YEAR(ST.SALES_DATE) = '2015' AND MONTH(ST.SALES_DATE) = '01'
GROUP BY ST.CUSTOMER_ID;

CREATE VIEW PREV_SALES
AS SELECT ST.CUSTOMER_ID, SUM(SD.PRODUCT_PRICE * SD.SALES_COUNT) AS SALES_AMOUNT
FROM SALES_TRAN ST INNER JOIN SALES_DETAIL SD
ON ST.SALES_ID = SD.SALES_ID
WHERE YEAR(ST.SALES_DATE) = '2014' AND MONTH(ST.SALES_DATE) = '01'
GROUP BY ST.CUSTOMER_ID;

SELECT THIS_SALES.CUSTOMER_ID, THIS_SALES.SALES_AMOUNT, PREV_SALES.SALES_AMOUNT,
THIS_SALES.SALES_AMOUNT - PREV_SALES.SALES_AMOUNT AS SALES_AMOUNT_DIFF
FROM THIS_SALES INNER JOIN PREV_SALES
ON THIS_SALES.CUSTOMER_ID = PREV_SALES.CUSTOMER_ID
ORDER BY SALES_AMOUNT_DIFF DESC;

// 2015年1月の前年同月と比べて売り上げが伸びた顧客 -- 多段ジョイン
SELECT ST1.CUSTOMER_ID, SUM(SD1.PRODUCT_PRICE * SD1.SALES_COUNT) THIS_SALES_AMOUNT,
PREV_SALES_AMOUNT,
SUM(SD1.PRODUCT_PRICE * SD1.SALES_COUNT) - PREV_SALES_AMOUNT SALES_AMOUNT_DIFF
FROM SALES_TRAN ST1
INNER JOIN SALES_DETAIL SD1 ON ST1.SALES_ID = SD1.SALES_ID
INNER JOIN (
    SELECT ST2.CUSTOMER_ID, SUM(SD2.PRODUCT_PRICE * SD2.SALES_COUNT) PREV_SALES_AMOUNT
    FROM SALES_TRAN ST2 INNER JOIN SALES_DETAIL SD2 ON ST2.SALES_ID = SD2.SALES_ID
    WHERE YEAR(ST2.SALES_DATE) = '2014' AND MONTH(ST2.SALES_DATE) = '01'
    GROUP BY ST2.CUSTOMER_ID
    ) PREV
ON ST1.CUSTOMER_ID = PREV.CUSTOMER_ID
WHERE YEAR(ST1.SALES_DATE) = '2015' AND MONTH(ST1.SALES_DATE) = '01'
GROUP BY ST1.CUSTOMER_ID, PREV_SALES_AMOUNT
ORDER BY SALES_AMOUNT_DIFF DESC;



